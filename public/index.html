<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Listener</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
        }

        .header h1 {
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .endpoint-section {
            background-color: #161b22;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .endpoint-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .endpoint-input {
            flex: 1;
            padding: 10px;
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 14px;
        }

        .endpoint-input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .create-btn {
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .create-btn:hover {
            background-color: #2ea043;
        }

        .create-btn:disabled {
            background-color: #30363d;
            cursor: not-allowed;
        }

        .endpoint-url {
            background-color: #21262d;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
            margin: 15px 0;
            word-break: break-all;
            position: relative;
            display: none;
        }

        .endpoint-url.show {
            display: block;
        }

        .endpoint-url code {
            color: #7ee787;
            font-family: 'Courier New', monospace;
        }

        .copy-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background-color: #2ea043;
        }

        .detail-section {
            position: relative;
        }

        .detail-content {
            position: relative;
        }

        .copy-icon {
            position: absolute;
            right: 8px;
            top: 8px;
            width: 20px;
            height: 20px;
            background-color: rgba(35, 134, 54, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0.7;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .copy-icon:hover {
            background-color: rgba(46, 160, 67, 0.9);
            opacity: 1;
            transform: scale(1.1);
        }

        .copy-feedback {
            position: absolute;
            right: 35px;
            top: 8px;
            background-color: #238636;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 11;
        }

        .copy-feedback.show {
            opacity: 1;
            transform: translateX(0);
        }

        .delete-icon {
            position: absolute;
            right: 8px;
            top: 8px;
            width: 20px;
            height: 20px;
            background-color: rgba(218, 54, 51, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0.7;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .delete-icon:hover {
            background-color: rgba(248, 81, 73, 0.9);
            opacity: 1;
            transform: scale(1.1);
        }

        .request-actions {
            position: absolute;
            right: 10px;
            top: 10px;
            display: flex;
            gap: 5px;
            opacity: 0.3;
            transition: opacity 0.2s ease;
            pointer-events: auto;
            z-index: 20;
        }

        .request-item:hover .request-actions {
            opacity: 1;
        }

        .action-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            vertical-align: middle;
            pointer-events: auto;
        }

        .action-btn.delete {
            background-color: rgba(218, 54, 51, 0.6);
            color: white;
            opacity: 0.7;
        }

        .action-btn.delete:hover {
            background-color: rgba(248, 81, 73, 0.9);
            transform: scale(1.1);
            opacity: 1;
        }

        .endpoint-info {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #0d1117;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .endpoint-info.show {
            display: block;
        }

        .endpoint-name {
            font-weight: bold;
            color: #58a6ff;
            margin-bottom: 5px;
        }

        .endpoint-created {
            color: #8b949e;
            font-size: 14px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
        }

        .clear-btn {
            background-color: #da3633;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-btn:hover {
            background-color: #f85149;
        }

        .clear-btn:disabled {
            background-color: #30363d;
            cursor: not-allowed;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #7ee787;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background-color: #f85149;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .requests-container {
            background-color: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
            overflow: hidden;
        }

        .request-item {
            border-bottom: 1px solid #30363d;
            padding: 20px;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .request-item:hover {
            background-color: #21262d;
        }

        .request-main {
            pointer-events: none;
            position: relative;
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .request-method {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }

        .method-GET { background-color: #238636; }
        .method-POST { background-color: #fd7e14; }
        .method-PUT { background-color: #6f42c1; }
        .method-DELETE { background-color: #dc3545; }
        .method-PATCH { background-color: #20c997; }

        .request-time {
            color: #8b949e;
            font-size: 14px;
        }

        .request-url {
            color: #58a6ff;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .request-details {
            display: none;
            margin-top: 15px;
        }

        .request-details.show {
            display: block;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-section h4 {
            color: #f0f6fc;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-content {
            background-color: #0d1117;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #30363d;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .detail-content.hljs {
            background-color: #0d1117 !important;
            padding: 10px;
        }

        .detail-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #58a6ff;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .expand-btn:hover {
            text-decoration: underline;
        }

        .no-requests {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .no-endpoint {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .request-count {
            color: #8b949e;
            font-size: 14px;
        }

        .error-message {
            background-color: #da3633;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background-color: #238636;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .cleanup-notice {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-top: 15px;
            padding: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 14px;
        }

        .notice-icon {
            font-size: 18px;
            margin-top: 2px;
        }

        .notice-content {
            flex: 1;
            line-height: 1.4;
        }

        .last-cleanup {
            color: #8b949e;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔗 Webhook Listener</h1>
            <p>Capture e monitore webhooks em tempo real - Multi-usuário</p>
            <div class="cleanup-notice" id="cleanupNotice">
                <div class="notice-icon">🗑️</div>
                <div class="notice-content">
                    <strong>Limpeza automática:</strong> Dados são removidos automaticamente após 60 dias para manter o sistema otimizado.
                    <div class="last-cleanup" id="lastCleanup"></div>
                </div>
            </div>
        </div>

        <div class="endpoint-section">
            <h3>Criar Novo Endpoint</h3>
            <div class="endpoint-form">
                <input 
                    type="text" 
                    class="endpoint-input" 
                    id="endpointName" 
                    placeholder="Nome do seu endpoint (ex: meu-app-payment)"
                    maxlength="50"
                >
                <button class="create-btn" id="createBtn" onclick="createEndpoint()">Criar Endpoint</button>
                <button class="clear-btn" id="newEndpointBtn" onclick="clearEndpointAndCreateNew()" style="display: none;">Novo Endpoint</button>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div class="endpoint-url" id="endpointUrlContainer">
                <code id="endpointUrl"></code>
                <button class="copy-btn" onclick="copyEndpointUrl()">Copiar</button>
            </div>
            
            <div class="endpoint-info" id="endpointInfo">
                <div class="endpoint-name" id="endpointName"></div>
                <div class="endpoint-created" id="endpointCreated"></div>
            </div>
        </div>

        <div class="controls" id="controlsSection" style="display: none;">
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Desconectado</span>
                <span class="request-count" id="requestCount">0 requests</span>
            </div>
            <button class="clear-btn" id="clearBtn" onclick="clearRequests()" disabled>Limpar Requests</button>
        </div>

        <div class="requests-container" id="requestsContainer" style="display: none;">
            <div id="requestsList">
                <div class="no-endpoint">
                    <h3>Nenhum endpoint ativo</h3>
                    <p>Crie um endpoint acima para começar a receber webhooks</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentEndpoint = null;
        let requests = [];
        let isConnected = false;
        let expandedRequests = new Set();

        socket.on('connect', () => {
            console.log('Connected to server');
            isConnected = true;
            updateConnectionStatus();
            
            // Reconnect to endpoint if we have one saved
            if (currentEndpoint) {
                socket.emit('join-endpoint', currentEndpoint.id);
                // Reload requests after reconnection
                setTimeout(() => {
                    loadRequests();
                }, 1000);
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            isConnected = false;
            updateConnectionStatus();
        });

        socket.on('new-request', (request) => {
            requests.unshift(request);
            updateRequestsList();
            updateRequestCount();
        });

        socket.on('requests-cleared', () => {
            requests = [];
            updateRequestsList();
            updateRequestCount();
        });

        socket.on('request-deleted', (requestId) => {
            requests = requests.filter(req => req.id !== requestId);
            updateRequestsList();
            updateRequestCount();
        });

        function updateConnectionStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isConnected) {
                statusDot.classList.remove('disconnected');
                statusText.textContent = currentEndpoint ? 'Monitorando' : 'Conectado';
            } else {
                statusDot.classList.add('disconnected');
                statusText.textContent = 'Desconectado';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }

        async function createEndpoint() {
            const nameInput = document.getElementById('endpointName');
            const createBtn = document.getElementById('createBtn');
            const name = nameInput.value.trim();
            
            if (!name) {
                showError('Nome do endpoint é obrigatório');
                return;
            }
            
            createBtn.disabled = true;
            createBtn.textContent = 'Criando...';
            
            try {
                const response = await fetch('/api/endpoints', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao criar endpoint');
                }
                
                // Set current endpoint
                currentEndpoint = data;
                
                // Save to localStorage
                localStorage.setItem('webhookEndpoint', JSON.stringify(data));
                
                // Join socket room
                socket.emit('join-endpoint', data.id);
                
                // Update UI
                document.getElementById('endpointUrl').textContent = data.url;
                document.getElementById('endpointUrlContainer').classList.add('show');
                document.getElementById('endpointInfo').classList.add('show');
                document.getElementById('endpointName').textContent = `Endpoint: ${data.name}`;
                document.getElementById('endpointCreated').textContent = `Criado em: ${new Date(data.created_at).toLocaleString('pt-BR')}`;
                
                // Show controls and requests
                document.getElementById('controlsSection').style.display = 'flex';
                document.getElementById('requestsContainer').style.display = 'block';
                document.getElementById('clearBtn').disabled = false;
                document.getElementById('newEndpointBtn').style.display = 'inline-block';
                
                // Load existing requests
                loadRequests();
                
                // Clear form
                nameInput.value = '';
                
                showSuccess('Endpoint criado com sucesso!');
                updateConnectionStatus();
                
            } catch (error) {
                showError(error.message);
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Criar Endpoint';
            }
        }

        async function loadRequests() {
            if (!currentEndpoint) return;
            
            try {
                const response = await fetch(`/api/endpoints/${currentEndpoint.id}/requests`);
                const data = await response.json();
                
                if (response.ok) {
                    requests = data;
                    updateRequestsList();
                    updateRequestCount();
                }
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        function updateRequestsList() {
            const requestsList = document.getElementById('requestsList');
            
            if (!currentEndpoint) {
                requestsList.innerHTML = `
                    <div class="no-endpoint">
                        <h3>Nenhum endpoint ativo</h3>
                        <p>Crie um endpoint acima para começar a receber webhooks</p>
                    </div>
                `;
                return;
            }
            
            if (requests.length === 0) {
                requestsList.innerHTML = `
                    <div class="no-requests">
                        <h3>Aguardando webhooks...</h3>
                        <p>Envie uma requisição para a URL do seu endpoint para ver os detalhes aqui</p>
                    </div>
                `;
                return;
            }

            requestsList.innerHTML = requests.map(request => `
                <div class="request-item" onclick="toggleDetails('${request.id}')">
                    <div class="request-main">
                        <div class="request-header">
                            <div>
                                <span class="request-method method-${request.method}">${request.method}</span>
                                <button class="action-btn delete" onclick="deleteRequest(event, '${request.id}')" title="Deletar request" style="margin-left: 10px;">🗑️</button>
                                <span style="margin-left: 10px; color: #8b949e; font-size: 12px;">Clique para ver detalhes</span>
                            </div>
                            <div class="request-time">${new Date(request.timestamp).toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="request-url">${request.url}</div>
                    </div>
                    <div class="request-details" id="details-${request.id}">
                        <div class="detail-section">
                            <h4>Headers</h4>
                            <div class="detail-content" id="headers-${request.id}">
                                <button class="copy-icon" onclick="copyDetailContent(event, 'headers-${request.id}')" title="Copiar">📋</button>
                                <div class="copy-feedback" id="feedback-headers-${request.id}">Copiado!</div>
                            </div>
                        </div>
                        ${request.body ? `
                            <div class="detail-section">
                                <h4>Body</h4>
                                <div class="detail-content" id="body-${request.id}">
                                    <button class="copy-icon" onclick="copyDetailContent(event, 'body-${request.id}')" title="Copiar">📋</button>
                                    <div class="copy-feedback" id="feedback-body-${request.id}">Copiado!</div>
                                </div>
                            </div>
                        ` : ''}
                        ${Object.keys(request.query).length > 0 ? `
                            <div class="detail-section">
                                <h4>Query Parameters</h4>
                                <div class="detail-content" id="query-${request.id}">
                                    <button class="copy-icon" onclick="copyDetailContent(event, 'query-${request.id}')" title="Copiar">📋</button>
                                    <div class="copy-feedback" id="feedback-query-${request.id}">Copiado!</div>
                                </div>
                            </div>
                        ` : ''}
                        <div class="detail-section">
                            <h4>Info</h4>
                            <div class="detail-content" id="info-${request.id}">
                                <button class="copy-icon" onclick="copyDetailContent(event, 'info-${request.id}')" title="Copiar">📋</button>
                                <div class="copy-feedback" id="feedback-info-${request.id}">Copiado!</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Apply syntax highlighting after content is added
            requests.forEach(request => {
                // Headers
                const headersElement = document.getElementById(`headers-${request.id}`);
                if (headersElement) {
                    const headersJson = JSON.stringify(request.headers, null, 2);
                    const copyIcon = headersElement.querySelector('.copy-icon');
                    const copyFeedback = headersElement.querySelector('.copy-feedback');
                    headersElement.innerHTML = `<pre><code class="language-json">${hljs.highlight(headersJson, {language: 'json'}).value}</code></pre>`;
                    headersElement.appendChild(copyIcon);
                    headersElement.appendChild(copyFeedback);
                }

                // Body
                if (request.body) {
                    const bodyElement = document.getElementById(`body-${request.id}`);
                    if (bodyElement) {
                        const bodyContent = formatBody(request.body);
                        const copyIcon = bodyElement.querySelector('.copy-icon');
                        const copyFeedback = bodyElement.querySelector('.copy-feedback');
                        if (isValidJSON(bodyContent)) {
                            bodyElement.innerHTML = `<pre><code class="language-json">${hljs.highlight(bodyContent, {language: 'json'}).value}</code></pre>`;
                        } else {
                            bodyElement.innerHTML = `<pre><code>${bodyContent}</code></pre>`;
                        }
                        bodyElement.appendChild(copyIcon);
                        bodyElement.appendChild(copyFeedback);
                    }
                }

                // Query Parameters
                if (Object.keys(request.query).length > 0) {
                    const queryElement = document.getElementById(`query-${request.id}`);
                    if (queryElement) {
                        const queryJson = JSON.stringify(request.query, null, 2);
                        const copyIcon = queryElement.querySelector('.copy-icon');
                        const copyFeedback = queryElement.querySelector('.copy-feedback');
                        queryElement.innerHTML = `<pre><code class="language-json">${hljs.highlight(queryJson, {language: 'json'}).value}</code></pre>`;
                        queryElement.appendChild(copyIcon);
                        queryElement.appendChild(copyFeedback);
                    }
                }

                // Info
                const infoElement = document.getElementById(`info-${request.id}`);
                if (infoElement) {
                    const infoContent = `IP: ${request.ip}
ID: ${request.id}
Endpoint ID: ${request.endpoint_id}`;
                    const copyIcon = infoElement.querySelector('.copy-icon');
                    const copyFeedback = infoElement.querySelector('.copy-feedback');
                    infoElement.innerHTML = `<pre><code>${infoContent}</code></pre>`;
                    infoElement.appendChild(copyIcon);
                    infoElement.appendChild(copyFeedback);
                }

                // Restore expanded state
                if (expandedRequests.has(request.id)) {
                    const details = document.getElementById(`details-${request.id}`);
                    if (details) {
                        details.classList.add('show');
                    }
                }
            });
        }

        function formatBody(body) {
            try {
                const parsed = JSON.parse(body);
                return JSON.stringify(parsed, null, 2);
            } catch {
                return body;
            }
        }

        function isValidJSON(str) {
            try {
                JSON.parse(str);
                return true;
            } catch {
                return false;
            }
        }

        function toggleDetails(requestId) {
            const details = document.getElementById(`details-${requestId}`);
            const isExpanded = details.classList.contains('show');
            
            if (isExpanded) {
                details.classList.remove('show');
                expandedRequests.delete(requestId);
            } else {
                details.classList.add('show');
                expandedRequests.add(requestId);
            }
        }

        function updateRequestCount() {
            const count = requests.length;
            document.getElementById('requestCount').textContent = 
                `${count} request${count !== 1 ? 's' : ''}`;
        }

        function copyEndpointUrl() {
            const url = document.getElementById('endpointUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copiado!';
                btn.style.backgroundColor = '#2ea043';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#238636';
                }, 2000);
            });
        }

        function copyDetailContent(event, elementId) {
            event.stopPropagation(); // Prevent triggering the row click
            
            const element = document.getElementById(elementId);
            let content = element.textContent;
            
            // If it's a formatted JSON element, get the original unformatted version
            const preElement = element.querySelector('pre code');
            if (preElement) {
                content = preElement.textContent;
            }
            
            // Remove the copy icon and feedback text from the content
            const copyIcon = element.querySelector('.copy-icon');
            const copyFeedback = element.querySelector('.copy-feedback');
            if (copyIcon) {
                content = content.replace('📋', '').replace('Copiado!', '').trim();
            }
            
            navigator.clipboard.writeText(content).then(() => {
                // Show feedback
                const feedbackElement = element.querySelector('.copy-feedback');
                if (feedbackElement) {
                    feedbackElement.classList.add('show');
                    setTimeout(() => {
                        feedbackElement.classList.remove('show');
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        async function clearRequests() {
            if (!currentEndpoint) return;
            
            if (confirm('Tem certeza que deseja limpar todas as requisições deste endpoint?')) {
                try {
                    const response = await fetch(`/api/endpoints/${currentEndpoint.id}/requests`, { 
                        method: 'DELETE' 
                    });
                    
                    if (response.ok) {
                        requests = [];
                        updateRequestsList();
                        updateRequestCount();
                        showSuccess('Requests limpos com sucesso!');
                    } else {
                        throw new Error('Erro ao limpar requests');
                    }
                } catch (error) {
                    showError(error.message);
                }
            }
        }

        // Allow Enter key to create endpoint
        document.getElementById('endpointName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createEndpoint();
            }
        });

        // Load saved endpoint on page load
        function loadSavedEndpoint() {
            const savedEndpoint = localStorage.getItem('webhookEndpoint');
            if (savedEndpoint) {
                try {
                    const endpointData = JSON.parse(savedEndpoint);
                    currentEndpoint = endpointData;
                    
                    // Join socket room (only if connected)
                    if (isConnected) {
                        socket.emit('join-endpoint', endpointData.id);
                    }
                    
                    // Update UI
                    document.getElementById('endpointUrl').textContent = endpointData.url;
                    document.getElementById('endpointUrlContainer').classList.add('show');
                    document.getElementById('endpointInfo').classList.add('show');
                    document.getElementById('endpointName').textContent = `Endpoint: ${endpointData.name}`;
                    document.getElementById('endpointCreated').textContent = `Criado em: ${new Date(endpointData.created_at).toLocaleString('pt-BR')}`;
                    
                    // Show controls and requests
                    document.getElementById('controlsSection').style.display = 'flex';
                    document.getElementById('requestsContainer').style.display = 'block';
                    document.getElementById('clearBtn').disabled = false;
                    document.getElementById('newEndpointBtn').style.display = 'inline-block';
                    
                    // Load existing requests
                    loadRequests();
                    
                    // Update connection status
                    updateConnectionStatus();
                    
                } catch (error) {
                    console.error('Error loading saved endpoint:', error);
                    localStorage.removeItem('webhookEndpoint');
                }
            }
        }

        function clearEndpointAndCreateNew() {
            if (confirm('Tem certeza que deseja criar um novo endpoint? O endpoint atual será perdido.')) {
                // Clear localStorage
                localStorage.removeItem('webhookEndpoint');
                
                // Reset current endpoint
                currentEndpoint = null;
                requests = [];
                
                // Hide UI elements
                document.getElementById('endpointUrlContainer').classList.remove('show');
                document.getElementById('endpointInfo').classList.remove('show');
                document.getElementById('controlsSection').style.display = 'none';
                document.getElementById('requestsContainer').style.display = 'none';
                document.getElementById('newEndpointBtn').style.display = 'none';
                
                // Reset requests list
                updateRequestsList();
                updateRequestCount();
                updateConnectionStatus();
                
                // Clear input
                document.getElementById('endpointName').value = '';
                
                showSuccess('Agora você pode criar um novo endpoint!');
            }
        }

        async function deleteRequest(event, requestId) {
            event.stopPropagation(); // Prevent triggering the row click
            
            if (!confirm('Tem certeza que deseja deletar este request?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/requests/${requestId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao deletar request');
                }
                
                showSuccess('Request deletado com sucesso!');
                
            } catch (error) {
                showError(error.message);
            }
        }

        // Load cleanup info
        async function loadCleanupInfo() {
            try {
                const response = await fetch('/api/cleanup-info');
                const data = await response.json();
                
                const lastCleanupElement = document.getElementById('lastCleanup');
                
                if (data.lastCleanup) {
                    const cleanupDate = new Date(data.lastCleanup).toLocaleString('pt-BR');
                    const stats = data.lastCleanupStats;
                    lastCleanupElement.textContent = `Última limpeza: ${cleanupDate} (${stats.endpointsDeleted} endpoints e ${stats.requestsDeleted} requests removidos)`;
                } else {
                    lastCleanupElement.textContent = 'Nenhuma limpeza realizada ainda.';
                }
                
            } catch (error) {
                console.error('Error loading cleanup info:', error);
                document.getElementById('lastCleanup').textContent = '';
            }
        }

        // Load saved endpoint when page loads
        window.addEventListener('load', () => {
            loadSavedEndpoint();
            loadCleanupInfo();
        });

        // Initial connection status
        updateConnectionStatus();
    </script>
</body>
</html>